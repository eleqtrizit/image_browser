<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ filename }} - Image Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            height: 100vh;
            overflow: hidden;
        }
        .viewer-container {
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            background-color: #000;
            display: flex;
            flex-direction: column;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 100;
        }
        .header h1 {
            font-size: 18px;
            margin: 0;
        }
        .navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .nav-button {
            padding: 8px 16px;
            background-color: rgba(0, 123, 255, 0.8);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin: 0 10px;
        }
        .nav-button:hover {
            background-color: rgba(0, 86, 179, 0.9);
        }
        .nav-button:disabled {
            background-color: rgba(204, 204, 204, 0.5);
            cursor: not-allowed;
        }
        .delete-button {
            padding: 8px 16px;
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin: 0 10px;
        }
        .delete-button:hover {
            background-color: rgba(200, 35, 51, 0.9);
        }
        .nav-button.prev::before {
            content: "← ";
        }
        .nav-button.next::after {
            content: " →";
        }
        .image-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .main-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            box-shadow: none;
            border-radius: 0;
        }
        .image-info {
            text-align: center;
            padding: 5px;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            font-size: 14px;
        }
        .image-caption {
            text-align: center;
            padding: 15px;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            font-size: 14px;
            max-width: 800px;
            margin: 0 auto;
        }
        .thumbnail-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .thumb-container {
            text-align: center;
            min-width: 100px;
        }
        .thumb-label {
            font-size: 14px;
            color: white;
            margin-bottom: 5px;
        }
        .thumb-image {
            max-width: 100px;
            max-height: 100px;
            width: auto;
            height: auto;
            object-fit: contain;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 3px;
        }
        .back-link {
            color: white;
            text-decoration: none;
            font-size: 14px;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .keyboard-hint {
            text-align: center;
            color: #ccc;
            font-size: 12px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.5);
        }
        @media (max-width: 768px) {
            .thumbnail-nav {
                flex-direction: column;
                align-items: center;
            }
            .main-image {
                max-height: 100%;
            }
            .thumb-container {
                min-width: 80px;
            }
            .thumb-image {
                max-width: 80px;
                max-height: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="viewer-container">
        <div class="header">
            <h1>Image Viewer</h1>
            <a href="/?page_size={{ current_page_size }}" class="back-link">← Back to Gallery</a>
        </div>

        <div class="navigation">
            <button class="nav-button prev" id="prev-button"
                    {% if not prev_filename %}disabled{% endif %}
                    onclick="setDirectionAndNavigate(-1, '{% if prev_filename %}{{ prev_filename }}{% endif %}')">
                Previous
            </button>

            <button class="delete-button" id="delete-button" onclick="deleteImage()">
                Delete
            </button>

            <button class="nav-button next" id="next-button"
                    {% if not next_filename %}disabled{% endif %}
                    onclick="setDirectionAndNavigate(1, '{% if next_filename %}{{ next_filename }}{% endif %}')">
                Next
            </button>
        </div>

        <div class="image-container">
            <img src="{{ full_image_url }}" alt="{{ filename }}" class="main-image" id="main-image">
        </div>

        <div class="image-info">
            <strong>{{ filename }}</strong> (Image {{ current_index }} of {{ total_images }})
        </div>

        {% if caption %}
        <div class="image-caption">{{ caption }}</div>
        {% endif %}

        {% if prev_filename or next_filename %}
        <div class="thumbnail-nav">
            {% if prev_filename %}
            <div class="thumb-container">
                <div class="thumb-label">Previous</div>
                <img src="/image/{{ prev_filename }}" alt="Previous: {{ prev_filename }}" class="thumb-image"
                     onclick="setDirectionAndNavigate(-1, '{{ prev_filename }}')">
            </div>
            {% endif %}

            {% if next_filename %}
            <div class="thumb-container">
                <div class="thumb-label">Next</div>
                <img src="/image/{{ next_filename }}" alt="Next: {{ next_filename }}" class="thumb-image"
                     onclick="setDirectionAndNavigate(1, '{{ next_filename }}')">
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="keyboard-hint">
            Keyboard shortcuts: ← → arrows for navigation, 'd' to delete, 'Esc' to return to gallery
        </div>
    </div>

    <script>
        // Track navigation direction: 1 for forward (next), -1 for backward (previous), 0 for none
        let navigationDirection = 0;

        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            // Prevent default behavior for arrow keys to avoid scrolling
            if (event.key === 'ArrowLeft' || event.key === 'ArrowRight' || event.key === 'd' || event.key === 'D') {
                event.preventDefault();
            }

            if (event.key === 'ArrowLeft' && document.getElementById('prev-button') && !document.getElementById('prev-button').disabled) {
                navigationDirection = -1; // Set direction to backward
                navigateTo('{{ prev_filename }}');
            } else if (event.key === 'ArrowRight' && document.getElementById('next-button') && !document.getElementById('next-button').disabled) {
                navigationDirection = 1; // Set direction to forward
                navigateTo('{{ next_filename }}');
            } else if ((event.key === 'd' || event.key === 'D') && document.getElementById('delete-button')) {
                deleteImage();
            } else if (event.key === 'Escape') {
                window.location.href = '/?page_size={{ current_page_size }}';
            }
        });

        function navigateTo(filename) {
            if (filename) {
                window.location.href = `/view/${filename}?size={{ current_size }}&page_size={{ current_page_size }}`;
            }
        }

        function setDirectionAndNavigate(direction, filename) {
            navigationDirection = direction;
            navigateTo(filename);
        }

        function deleteImage() {
            if (confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
                // Send DELETE request to server
                fetch(`/delete/{{ filename }}`, {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        // After successful deletion, navigate based on the last navigation direction
                        if (navigationDirection === -1 && '{{ prev_filename }}') {
                            // Was going backward, so continue backward
                            window.location.href = `/view/{{ prev_filename }}?size={{ current_size }}&page_size={{ current_page_size }}`;
                        } else if ('{{ next_filename }}') {
                            // Default behavior: go to next image (forward navigation)
                            window.location.href = `/view/{{ next_filename }}?size={{ current_size }}&page_size={{ current_page_size }}`;
                        } else if ('{{ prev_filename }}') {
                            // Fallback to previous image if no next image available
                            window.location.href = `/view/{{ prev_filename }}?size={{ current_size }}&page_size={{ current_page_size }}`;
                        } else {
                            // Otherwise go back to gallery
                            window.location.href = '/?page_size={{ current_page_size }}';
                        }
                    } else {
                        alert('Failed to delete image.');
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the image.');
                });
            }
        }

        // Preload adjacent images for smoother navigation
        window.addEventListener('load', function() {
            {% if prev_filename %}
            const prevImg = new Image();
            prevImg.src = '/image/{{ prev_filename }}';
            {% endif %}

            {% if next_filename %}
            const nextImg = new Image();
            nextImg.src = '/image/{{ next_filename }}';
            {% endif %}
        });
    </script>
</body>
</html>